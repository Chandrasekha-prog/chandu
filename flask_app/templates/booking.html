{% extends "layout.html" %}

{% block content %}
<div class="max-w-4xl mx-auto mb-10">
    <div class="flex items-center gap-4 mb-6">
        <a href="{{ url_for('dashboard') }}"
            class="text-gray-500 hover:text-gray-700 bg-white shadow-sm p-2 rounded-lg border border-gray-200 transition-colors">
            ‚Üê Dashboard
        </a>
        <div>
            <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                üõí Buy Fertilizers
            </h1>
            <p class="text-gray-500 mt-1">Book your required field inputs online with door-step delivery.</p>
        </div>
    </div>

    <!-- Active Bookings History -->
    {% if bookings %}
    <div class="mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b border-gray-200 pb-2">Your Recent Orders</h2>
        <div class="space-y-3">
            {% for booking in bookings %}
            <div
                class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex flex-col sm:flex-row justify-between sm:items-center gap-3">
                <div class="flex items-center gap-4">
                    <div class="text-3xl">üì¶</div>
                    <div>
                        <h3 class="font-bold text-gray-800 text-lg">{{ booking.fertilizer_name }}</h3>
                        <p class="text-xs text-gray-500">Ordered on: {{ booking.created_at[:10] }} &bull; Quantity: {{
                            booking.quantity_kg }} kg</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-xl font-black text-primary-600">‚Çπ{{ booking.total_price }}</p>
                    <span
                        class="inline-block mt-1 bg-{{ 'green' if booking.status == 'Delivered' else 'orange' }}-100 text-{{ 'green' if booking.status == 'Delivered' else 'orange' }}-800 text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider">
                        {{ booking.status }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Booking Form -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- Order Placement -->
        <div class="card space-y-5 bg-white shadow-sm">
            <h2 class="text-xl font-bold text-gray-800 mb-2 border-b border-gray-100 pb-2 flex items-center gap-2">
                üõçÔ∏è Place New Order
            </h2>

            <form id="booking-form" action="{{ url_for('book_fertilizers') }}" method="POST" class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Select Fertilizer *</label>
                    <select name="fertilizer" id="fertilizer-select" required
                        class="input-field bg-gray-50 cursor-pointer" onchange="calculatePrice()">
                        <option value="" data-price="0">-- Choose Product --</option>
                        <option value="Urea" data-price="5.8">Urea (‚Çπ5.8/kg)</option>
                        <option value="DAP" data-price="24">DAP (‚Çπ24/kg)</option>
                        <option value="MOP" data-price="17">MOP (‚Çπ17/kg)</option>
                        <option value="Complex 19:19:19" data-price="20">Complex 19:19:19 (‚Çπ20/kg)</option>
                        <option value="Complex 20:20:0:13" data-price="18">Complex 20:20:0:13 (‚Çπ18/kg)</option>
                        <option value="SSP" data-price="8">SSP (‚Çπ8/kg)</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Quantity (kg) *</label>
                        <input type="number" name="quantity" id="quantity" step="1" min="1" value="50"
                            class="input-field" required oninput="calculatePrice()">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Price Estimate</label>
                        <div
                            class="h-[42px] bg-green-50 border border-green-200 rounded-lg flex items-center px-4 font-black text-green-700 text-lg">
                            ‚Çπ<span id="price-display">0.00</span>
                        </div>
                        <input type="hidden" name="total_price" id="total_price" value="0">
                    </div>
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Delivery Details</label>
                    <textarea name="delivery_address" rows="2" class="input-field block w-full bg-gray-50"
                        placeholder="Nearest landmark, house number, details..."
                        required>{{ farmer.mandal }}, {{ farmer.district }}</textarea>
                </div>

                <div class="pt-2">
                    <label class="block text-gray-700 font-semibold mb-2">Payment Mode</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="cursor-pointer">
                            <input type="radio" name="payment_method" value="COD" class="peer hidden" checked>
                            <div
                                class="peer-checked:bg-primary-50 peer-checked:border-primary-500 border-2 border-transparent rounded-xl p-3 text-center font-semibold text-gray-700 bg-gray-100 transition-all hover:bg-gray-200 flex flex-col items-center">
                                <span class="text-2xl mb-1">üíµ</span> COD
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="payment_method" value="Online" class="peer hidden">
                            <div
                                class="peer-checked:bg-primary-50 peer-checked:border-primary-500 border-2 border-transparent rounded-xl p-3 text-center font-semibold text-gray-700 bg-gray-100 transition-all hover:bg-gray-200 flex flex-col items-center">
                                <span class="text-2xl mb-1">üí≥</span> Pay Online
                            </div>
                        </label>
                    </div>
                </div>

                <input type="hidden" name="payment_status" id="payment_status" value="Pending">

                <button type="submit" id="checkout-btn"
                    class="w-full bg-primary-600 hover:bg-primary-700 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-md transition-shadow flex justify-center items-center gap-2">
                    Complete Order ‚úÖ
                </button>
            </form>
        </div>

        <!-- Info Sidebar -->
        <div class="card bg-gray-50 shadow-inner h-fit">
            <h3 class="font-bold text-gray-800 text-lg mb-3">Notice</h3>
            <ul class="text-sm text-gray-600 space-y-3">
                <li class="flex items-start gap-2">
                    <span class="mt-0.5 text-primary-500">‚úì</span>
                    Standard delivery occurs within 2-3 business days through Krishi Kendra fulfillment centers.
                </li>
                <li class="flex items-start gap-2">
                    <span class="mt-0.5 text-primary-500">‚úì</span>
                    Payment will be collected as Cash-on-Delivery (COD) or POS credit terminal at the farm gate.
                </li>
                <li class="flex items-start gap-2">
                    <span class="mt-0.5 text-primary-500">‚úì</span>
                    Pricing displayed is subject to government subsidies. Provide your Aadhaar upon delivery to claim
                    full subsidies.
                </li>
            </ul>
        </div>

    </div>
</div>

<!-- Mock Gateway Modal -->
<div id="payment-modal"
    class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm hidden flex-col items-center justify-center">
    <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl transform transition-all translate-y-4 opacity-0 scale-95"
        id="payment-card">
        <!-- Header -->
        <div class="bg-gray-900 p-5 text-white flex justify-between items-center">
            <h2 class="font-bold text-lg flex items-center gap-2"><span>üõ°Ô∏è</span> Secure Checkout</h2>
            <button type="button" onclick="closeGateway()"
                class="text-gray-400 hover:text-white font-bold">&times;</button>
        </div>

        <!-- Processing State (hidden initially) -->
        <div id="payment-processing" class="hidden p-10 flex-col items-center justify-center text-center">
            <div class="w-16 h-16 border-4 border-gray-100 border-t-green-500 rounded-full animate-spin mb-4"></div>
            <h3 class="font-bold text-xl text-gray-800">Processing Payment...</h3>
            <p class="text-gray-500 mt-2 text-sm">Please do not press back or refresh.</p>
        </div>

        <!-- Success State (hidden initially) -->
        <div id="payment-success" class="hidden p-8 flex-col items-center justify-center text-center">
            <div
                class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-4xl mb-4 shadow-lg animate-bounce">
                ‚úì
            </div>
            <h3 class="font-black text-2xl text-gray-800">Payment Successful!</h3>
            <p class="text-gray-500 mt-2 text-sm">‚Çπ<span id="gateway-paid-amount">0.00</span> paid</p>
        </div>

        <!-- UPI Payment Screen (hidden initially) -->
        <div id="upi-payment-screen" class="hidden p-6 flex-col items-center justify-center text-center">
            <h3 class="font-bold text-lg text-gray-800 mb-2">Scan to Pay via UPI</h3>
            <div class="bg-gray-50 p-2 rounded-xl border border-gray-200 inline-block mb-3 shadow-inner">
                <img id="upi-qr" src="" alt="UPI QR Code" class="w-48 h-48 mx-auto">
            </div>
            <p class="font-black text-primary-600 text-xl mb-1">‚Çπ<span id="upi-amount">0.00</span></p>
            <p class="text-sm text-gray-500 font-medium mb-4">UPI ID: <span class="text-gray-800">6305412922@ibl</span>
            </p>

            <a id="upi-intent-link" href="#"
                class="w-full bg-blue-100 text-blue-800 font-bold py-3 rounded-xl mb-3 flex items-center justify-center gap-2 hover:bg-blue-200 md:hidden">
                üì± Open UPI App (Mobile)
            </a>

            <button type="button" onclick="confirmUpiPayment()"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md">
                I have paid via UPI ‚úÖ
            </button>
            <button type="button" onclick="backToMethods()"
                class="text-sm text-gray-400 font-medium hover:text-gray-800 mt-4">
                ‚Üê Go Back
            </button>
        </div>

        <!-- Payment Options Form -->
        <div id="payment-options" class="p-6">
            <div class="text-center mb-6">
                <p class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-1">To Pay</p>
                <div class="text-4xl font-black text-gray-900">‚Çπ<span id="gateway-amount">0.00</span></div>
            </div>

            <p class="text-sm text-gray-500 font-semibold mb-3 border-b pb-2">Select Payment Method</p>
            <div class="space-y-3">
                <button type="button" onclick="showUpiQR()"
                    class="w-full text-left bg-white border border-green-200 hover:border-green-400 hover:bg-green-50 p-4 rounded-xl flex items-center gap-3 transition-colors active:scale-95 duration-150">
                    <div class="bg-white shadow rounded p-1 w-10 flex justify-center"><img
                            src="https://upload.wikimedia.org/wikipedia/commons/e/e1/UPI-Logo-vector.svg"
                            class="h-4 object-contain"></div>
                    <span class="font-bold text-green-700">Pay via UPI QR / PhonePe</span>
                </button>
                <button type="button" onclick="processPayment()"
                    class="w-full text-left bg-white border border-gray-200 hover:border-blue-400 hover:bg-blue-50 p-4 rounded-xl flex items-center gap-3 transition-colors active:scale-95 duration-150">
                    <div class="bg-gray-100 rounded text-xl w-10 h-6 flex justify-center items-center">üí≥</div>
                    <span class="font-bold text-gray-700">Credit / Debit Card</span>
                </button>
                <button type="button" onclick="processPayment()"
                    class="w-full text-left bg-white border border-gray-200 hover:border-blue-400 hover:bg-blue-50 p-4 rounded-xl flex items-center gap-3 transition-colors active:scale-95 duration-150">
                    <div class="bg-gray-100 rounded text-xl w-10 h-6 flex justify-center items-center">üè¶</div>
                    <span class="font-bold text-gray-700">Net Banking</span>
                </button>
            </div>

            <p class="text-xs text-center text-gray-400 mt-6 flex justify-center items-center gap-1">
                <span class="text-[10px]">üîí</span> Secured by MockPay Integration
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function calculatePrice() {
        const select = document.getElementById('fertilizer-select');
        const qty = parseFloat(document.getElementById('quantity').value) || 0;
        const selectedOption = select.options[select.selectedIndex];

        const pricePerKg = parseFloat(selectedOption.getAttribute('data-price')) || 0;
        const total = pricePerKg * qty;

        document.getElementById('price-display').innerText = total.toFixed(2);
        document.getElementById('total_price').value = total.toFixed(2);
    }

    // Calculate initial
    calculatePrice();

    const form = document.getElementById('booking-form');
    const modal = document.getElementById('payment-modal');
    const paymentCard = document.getElementById('payment-card');

    // Intercept form submission
    form.addEventListener('submit', function (e) {
        const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
        const totalAmount = document.getElementById('total_price').value;

        // If it's Cash On Delivery just submit
        if (paymentMethod === "COD") {
            document.getElementById('payment_status').value = "Pending (COD)";
            document.getElementById('checkout-btn').innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> Processing...`;
            return true;
        }

        // It's Online
        e.preventDefault();

        // Show gateway modal
        document.getElementById('gateway-amount').innerText = totalAmount;
        document.getElementById('gateway-paid-amount').innerText = totalAmount;

        // Reset states
        document.getElementById('payment-options').classList.remove('hidden');
        document.getElementById('payment-processing').classList.add('hidden', 'flex');
        document.getElementById('payment-success').classList.add('hidden', 'flex');
        document.getElementById('upi-payment-screen').classList.add('hidden', 'flex');

        modal.classList.remove('hidden');
        modal.classList.add('flex');

        // Animate in
        setTimeout(() => {
            paymentCard.classList.remove('translate-y-4', 'opacity-0', 'scale-95');
        }, 10);
    });

    function showUpiQR() {
        const totalAmount = document.getElementById('total_price').value;
        const upiId = "6305412922@ibl";
        const merchantName = "Krish-e-Mitra";

        // Build the precise intent URI string and encode it for the QR generator API
        const upiUri = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(merchantName)}&am=${totalAmount}&cu=INR`;
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(upiUri)}`;

        document.getElementById('upi-qr').src = qrUrl;
        document.getElementById('upi-amount').innerText = totalAmount;
        document.getElementById('upi-intent-link').href = upiUri;

        document.getElementById('payment-options').classList.add('hidden');
        document.getElementById('upi-payment-screen').classList.remove('hidden');
        document.getElementById('upi-payment-screen').classList.add('flex');
    }

    function backToMethods() {
        document.getElementById('upi-payment-screen').classList.add('hidden', 'flex');
        document.getElementById('payment-options').classList.remove('hidden');
    }

    function confirmUpiPayment() {
        // Assume user paid successfully, hide QR and show processing
        document.getElementById('upi-payment-screen').classList.add('hidden', 'flex');
        processPayment(); // Uses the same fake network delay finish
    }

    function closeGateway() {
        paymentCard.classList.add('translate-y-4', 'opacity-0', 'scale-95');
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 300);
    }

    function processPayment() {
        // Hide options, show spinner
        document.getElementById('payment-options').classList.add('hidden');
        document.getElementById('payment-processing').classList.remove('hidden');

        // Simulate network API delay for payment
        setTimeout(() => {
            document.getElementById('payment-processing').classList.add('hidden');
            document.getElementById('payment-success').classList.remove('hidden');

            // Wait 1.5 seconds on success screen then submit actual order form
            setTimeout(() => {
                document.getElementById('payment_status').value = "Paid Validated";
                // Add loading to original button too
                document.getElementById('checkout-btn').innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> Finalizing...`;
                closeGateway();

                // Allow form submit to backend
                form.submit();

            }, 1800);

        }, 3000);
    }
</script>
{% endblock %}